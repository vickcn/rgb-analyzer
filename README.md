# 🎨 RGB 色光檢測器

基於 React + TypeScript + OpenCV.js 的手機攝影機RGB色光檢測應用程式。

## ✨ 功能特色

- 📷 即時攝影機存取 (WebRTC API)
- 🔍 智能邊緣檢測 (Canny 演算法)
- 💡 色光區域識別 (HSV 色彩空間)
- 🎨 RGB值提取與顯示
- 📊 檢測歷史記錄
- ⚙️ 可調檢測參數
- 🟩 可拖曳/縮放的檢測範圍 ROI（矩形框）
- 💾 保存當前畫面為圖片（包含 ROI 標記）
- 💾 兩種保存：原圖與標註圖（含 ROI 與 RGB 資訊卡）
- 🎨 RGB 3D 相位圖視覺化（時段區間記錄功能）
- ⛶ 全螢幕模式支援
- 📱 響應式設計
- 🌐 PWA支援

### 新增（ROI 與像素過濾）

- ROI 內縮邊界：自動向內縮一圈以避免邊緣黑邊干擾；ROI 太小時會自動回退
- 像素過濾：可排除近白、近黑與低飽和像素，再計算平均 RGB；若全被過濾會自動回退用未過濾平均
- 參數皆可在控制面板調整

## 🚀 快速開始

### 本地開發
```bash
npm install
npm start
```

### 部署到 Vercel
1. 推送代碼到 GitHub
2. 連接 Vercel 帳號
3. 選擇倉庫並部署

## 🛠️ 技術架構

- **React 18 + TypeScript** - 前端框架
- **OpenCV.js** - 圖像處理
- **WebRTC API** - 攝影機存取
- **GitHub + Vercel** - 部署平台

## 📱 使用說明

1. 點擊「啟動攝影機」
2. 授予攝影機權限
3. 對準燈珠或色光區域
4. 查看即時RGB檢測結果
5. 需要暫停畫面時，點擊「⏸ 定格畫面」；要恢復，點擊「⏯ 解除定格」
6. 點擊「💾 保存圖片」可將當前畫面（包含 ROI 標記）下載到裝置
7. 需要進階保存時，使用「💾 保存原圖」或「💾 保存標註圖」
8. 使用「⏺️ 開始記錄」進行時段區間 RGB 數據收集，記錄完成後自動生成 3D 相位圖
9. 點擊「⛶ 全螢幕」進入全螢幕模式，獲得更大的檢測視野

### ROI 操作

- 按住影像上任一處拖曳可「建立」並調整 ROI 尺寸
- 拖曳 ROI 內部可「移動」位置；拖曳右下角把手可「縮放」
- 系統只會對 ROI 內的像素取樣計算平均 RGB 值

#### ROI 內縮與安全回退

- 預設向內縮 5%（至少 2px）；計算時僅使用內縮後的 ROI 區域
- 若內縮後區域過小（例如寬或高 < 8px），會自動回退使用原 ROI 以避免無像素可算

#### 筆電操作（滑鼠/觸控板）

- 將滑鼠移到鏡頭畫面上，使用滑鼠滾輪或 Mac 觸控板捏拉手勢即可縮放 ROI
- 未建立 ROI 時，首次滾動會在游標附近建立預設大小的 ROI

### 定格功能（Freeze Frame）

- **按鈕位置**: 在攝影機控制列中會出現「⏸ 定格畫面 / ⏯ 解除定格」按鈕（僅在攝影機啟動後顯示）。
- **行為**:
  - 點擊「⏸ 定格畫面」後，會暫停 `video` 播放，畫面維持最後一幀並停止後續檢測；歷史與當前 RGB 保持不再更新。
  - 點擊「⏯ 解除定格」後，恢復 `video` 播放與每幀檢測循環。
- **注意**:
  - 定格時仍可調整 ROI，但檢測數值不會更新，直到解除定格。
  - RGB 資訊卡會自動避開 ROI 檢測框和功能按鈕區域，確保資訊清晰可見。
  - 如需完全關閉攝影機，請使用「📷 停止攝影機」。

### 保存圖片功能

- **按鈕位置**: 在攝影機控制列中會出現「💾 保存原圖 / 💾 保存標註圖」按鈕（僅在攝影機啟動後顯示）。
- **保存原圖**:
  - 直接輸出當前畫面為 PNG，不含任何標記
  - 檔案名稱：`rgb-raw-YYYY-MM-DDTHH-mm-ss-sssZ.png`
- **保存標註圖**:
  - 輸出當前畫面，並繪製 ROI 框
  - 在畫面一角自動放置資訊卡（盡量避開 ROI）
  - 資訊卡為白底 70% 透明、黑字；包含 HEX 與 RGB
  - 旁附色塊，大小為畫面短邊的 1/20，帶黑色邊框
  - 檔案名稱：`rgb-annotated-YYYY-MM-DDTHH-mm-ss-sssZ.png`
  - 若暫無 RGB 數據，會顯示「尚無 RGB 數據」
- **注意**:
  - 保存過程中按鈕會顯示「💾 保存中...」並暫時禁用
  - 需要攝影機正在運行才能保存圖片
  - 保存的圖片解析度與攝影機畫面相同

### RGB 3D 相位圖視覺化

- **功能說明**: 透過時段區間記錄功能，收集多個時間點的 RGB 數據，並在 3D 空間中視覺化顯示
- **操作步驟**:
  1. 確保攝影機已啟動且 ROI 已設定
  2. 點擊「⏺️ 開始記錄」按鈕開始數據收集
  3. 在記錄期間，系統會定期採樣當前 RGB 值（預設間隔時間）
  4. 點擊「⏹️ 停止記錄」結束數據收集
  5. 記錄完成後，系統會自動顯示 3D 相位圖視覺化
- **3D 視覺化特色**:
  - 🎨 **3D RGB 座標系統**: 以 R、G、B 為三軸的立體座標空間
  - 🔄 **互動旋轉**: 滑鼠拖拽可旋轉 3D 視圖，滾輪可縮放
  - 📊 **數據點顯示**: 每個記錄點以彩色圓點顯示，顏色對應其 RGB 值
  - 📈 **平均值標示**: 紅色邊框圓點標示所有數據的平均 RGB 值
  - 🔗 **連線分析**: 各數據點與平均值間有淺色連線，便於分析分佈
  - 📦 **RGB 立方體框架**: 顯示完整的 RGB 色彩空間邊界
- **匯出功能**:
  - 📊 **Excel 報告**: 匯出包含所有記錄數據的 Excel 檔案
  - 🖼️ **圖片匯出**: 匯出 3D 視覺化圖像
- **注意事項**:
  - 需要記錄超過 1 筆數據才會顯示 3D 視覺化
  - 匯出後會自動清除記錄數據並關閉 3D 視覺化
  - 3D 視覺化使用 Canvas 2D 渲染，支援所有現代瀏覽器

### 全螢幕模式

- **功能說明**: 讓攝影機畫面本身全螢幕顯示，獲得更大的檢測視野，特別適合精確的 RGB 檢測工作
- **操作方式**:
  - 點擊「⛶ 全螢幕」按鈕讓攝影機畫面進入全螢幕模式
  - 在全螢幕模式下，按鈕會變為「🔲 退出全螢幕」
  - 也可使用 ESC 鍵或瀏覽器預設的全螢幕退出方式
- **全螢幕特色**:
  - 📺 **攝影機全螢幕**: 只有攝影機畫面全螢幕，其他 UI 元素保持正常
  - 🎯 **精確檢測**: 更大的攝影機畫面有助於更精確的 ROI 設定和 RGB 檢測
  - 🔄 **完整功能**: 在全螢幕模式下仍可使用所有檢測功能（定格、保存、時段紀錄等）
  - 🎮 **浮動控制**: 控制按鈕在全螢幕模式下會以半透明浮動面板顯示
  - 📱 **跨平台支援**: 支援桌面和行動裝置的全螢幕 API
- **注意事項**:
  - 全螢幕模式需要用戶手勢觸發（點擊按鈕）
  - 某些瀏覽器可能需要在安全上下文（HTTPS）中才能使用全螢幕功能
  - 在全螢幕模式下，RGB 資訊卡仍會自動避開檢測框和按鈕區域
  - 時段紀錄功能在全螢幕模式下完全可用

## ⚙️ 可調參數

在右側「檢測設定」面板可即時調整以下參數：

- 檢測模式
  - 邊緣檢測（Canny）：`edgeThreshold1`, `edgeThreshold2`
  - 色光檢測切換：`enableColorDetection`
  - 詳細 Log：`enableDetailedLogs`

- 通用參數
  - 最小區域：`minArea`
  - 模糊核大小（奇數）：`blurKernel`

- ROI 與像素過濾
  - ROI 內縮比例（%）：`edgeMarginPercent`（預設 5）
  - 內縮最小像素：`minEdgeMarginPx`（預設 2）
  - 近白門檻（0-255）：`whiteThreshold`（預設 240）
  - 近黑門檻（0-255）：`blackThreshold`（預設 10）
  - 最小飽和度（0-255）：`minSaturation`（預設 10）
  - 取樣步距（px）：`sampleStep`（預設 2）

預設值亦定義於 `defaultProcessingSettings` 與 `App` 的 `detectionSettings` 初始化，二者保持一致。

## 🧭 座標系統與一致性

- ROI 使用「容器本地座標」（容器左上為 \(0,0\)），拖曳與縮放皆以此座標更新
- 計算時再做一次線性映射到 Canvas：
  - \(\text{scaleX} = \frac{\text{canvas.width}}{\text{canvasRect.width}}\)\,\, \(\text{scaleY} = \frac{\text{canvas.height}}{\text{canvasRect.height}}\)
  - \(\text{roiCanvas} = (x\cdot\text{scaleX},\, y\cdot\text{scaleY},\, w\cdot\text{scaleX},\, h\cdot\text{scaleY})\)
- 每幀皆讀取最新 ROI 狀態進行計算，避免閉包取到舊值

### 疑難排解：拖曳的框與計算的框不一致

1. 重新整理頁面以重置攝影機與繪圖狀態
2. 確認沒有套用會改變元素幾何的外層 CSS 轉換（如 `transform: scale(...)`）
3. 關閉系統放大鏡/螢幕縮放工具後再試（瀏覽器頁面縮放可正常運作）
4. 若仍發生，請回報瀏覽器、作業系統與重現步驟

## 🌐 瀏覽器支援

Chrome 60+, Firefox 55+, Safari 11+, Edge 79+

## 📄 授權

MIT License