# 彩色燈光分類驗證腳本

## 用途

使用 `imgData/` 目錄下的圖片驗證 HSV + 色溫綜合分析方法的準確性。

## 使用方式

```bash
# 進入 pysrc 目錄
cd /Users/kexuen/projects/rgbAnalyzer/pysrc

# 執行驗證腳本
python color_classification_validator.py
```

### 單張圖片測試

如果想測試單張圖片進行調試：

```bash
python test_single_image.py ../imgData/網白偏綠.png
```

測試結果會輸出到 `pysrc/test/` 目錄。

## 功能特點

### 1. 顏色提取方法（參考 pysrc_v0）

採用品質良好的邊緣檢測方法：

**步驟1：黑白閾值過濾（增強版）**
- 黑色閾值：R < 30, G < 30, B < 30（去除黑色背景和文字）
- 白色閾值：R > 225, G > 225, B > 225（去除白色背景和文字）
- **新增：近白色檢測**：所有通道 > 200 且差異 < 10（去除白色文字框）
- **新增：單色檢測**：通道差異 < 5（去除單色文字框，如黑字白底）
- 創建遮罩排除極端像素和單色區域

**步驟2：Canny 邊緣檢測**
- 高斯模糊降噪（kernel 5x5）
- Canny 邊緣檢測（閾值 50-150）
- 形態學操作連接邊緣

**步驟3：區域提取和過濾（增強版）**
- 尋找輪廓
- 過濾小區域（面積 < 100 像素）
- **智能文字框過濾**：
  - 排除極端純白區域（RGB > 245 且色差 < 8）
  - **排除偏正白大區域**（亮度 > 220 + 色差 < 15 + 面積 > 1000）
  - 排除純黑區域（RGB < 10）
  - 排除文字框形狀（長寬比 < 3 + extent < 0.3 + 低飽和度）
- **保留有色光**：
  - 保留「白偏X」類顏色（有明顯色偏）
  - 保留有飽和度的彩色區域
- 只統計有效色光區域的像素

**步驟4：計算平均值**
- 對有效區域的像素計算 RGB 平均值
- 得到代表該色光的主導顏色

### 2. 綜合分類邏輯
使用 HSV + 色溫綜合分析：

- **HSV 提供**：
  - 色相角（Hue）：判斷偏藍、偏綠、偏粉
  - 飽和度（Saturation）：判斷純度和白色系
  - 明度（Value）：判斷亮度

- **色溫提供**：
  - 冷暖傾向（Kelvin）
  - 光源特性

### 3. 針對性分類

專門針對 `imgData/` 中的色光類型：

- **白色系列**：冰白、冰藍白、冰暖白、白偏藍、白偏綠、白偏粉、暖白
- **彩色系列**：香檳金、桃紅、粉色、紫色、藍色、綠色等
- **網路燈系列**：網紅A/B、網藍A/B、網紫、網綠、網草綠、網白偏綠等

## 分類邏輯

### 白色系列（S < 25%, V > 75%）
- 高色溫（>6500K）+ 色相 200-230° → 冰藍白
- 色相 170-200° → 白偏藍
- 色相 100-130° → 白偏綠
- 中等色溫 + 色相 100-130° → 白偏綠
- 中等色溫 + 色相 300°/0° → 白偏粉

### 香檳金
- 色溫 3000-4000K
- 色相 15-45°
- 飽和度 30-60%
- 明度 > 70%

### 彩色系列
根據色相角進行分類：
- 0-20°/330-360°：紅色/桃紅/粉色
- 200-250°：藍色系列
- 270-300°：紫色系列
- 100-160°：綠色系列

## 輸出結果

腳本會：
1. 逐張分析圖片
2. 輸出 RGB、HSV、色溫數據
3. 顯示分類結果
4. 計算準確率
5. 匯出詳細結果到 `output/color_analysis_result.txt`
6. **生成邊緣框圖片**到 `output/邊緣框檔/`（參考 pysrc_v0）

### 輸出結構

```
output/
├── 邊緣框檔/                # 邊緣框示意圖
│   ├── 白偏藍_邊緣框.png
│   ├── 白偏綠_邊緣框.png
│   ├── 香檳金_邊緣框.png
│   └── ...
├── color_analysis_result.txt  # 詳細文字報告
└── color_analysis_result.xlsx # Excel 報告（新增）
```

### Excel 報告內容

Excel 報告包含以下欄位：

| 欄位 | 說明 |
|------|------|
| 編號 | 序號 |
| 圖片名稱 | 原始檔案名 |
| RGB | RGB 組合字串 |
| R, G, B | 紅綠藍通道數值 (0-255) |
| HSV | HSV 組合字串 |
| H, S, V | 色相、飽和度、明度 |
| HSL | HSL 組合字串 |
| HSL_H, HSL_S, HSL_L | HSL 詳細數值 |
| 色溫 (K) | 色溫數值（Kelvin） |
| 色溫描述 | 色溫的文字描述 |
| 分類結果 | 自動分類的色光類型 |
| 邊緣框檔 | 邊緣框圖片的檔案名 |

**Excel 特色**：
- 藍色標題列，白色粗體字
- 自動調整列寬
- 凍結首行便於滾動查看
- 完整的色度數據展示

### 邊緣框圖片說明

每張邊緣框圖片會顯示：
- **綠色輪廓**：Canny 邊緣檢測結果
- **藍色矩形框**：檢測到的色光區域
- **紅色編號**：區域編號（從1開始）

這些框框幫助你了解：
- 算法成功檢測到的色光區域
- 哪些區域被用來計算 RGB 平均值
- 檢測是否準確排除了文字說明和背景

## 範例輸出

```
分析圖片: 白偏藍.png
============================================================
圖片尺寸: 800 x 600

主導顏色: RGB(230, 240, 255)
HSV: H=200.5°, S=15.2%, V=96.1%
色溫: 7500K
分類結果: 白偏藍
============================================================
```

## 注意事項

1. **圖片格式**：支援 PNG、JPG 等 OpenCV 支援的格式
2. **顏色提取方法**：
   - ✅ 使用**黑白閾值過濾**（去除極端像素）
   - ✅ 使用**Canny 邊緣檢測**找出色光區域
   - ✅ 自動過濾小面積區域（< 100 像素）
   - ✅ 專注統計有效色光區域
3. **優於簡單方法**：
   - 舊方法：隨機取樣 → 可能包含背景和文字
   - 新方法：邊緣檢測 → 精確定位色光區域
4. **結果解讀**：
   - 完全匹配：預測結果與檔案名一致
   - 部分匹配：預測結果包含核心特徵（如「暖白」都算匹配）
   - 不匹配：需要調整分類閾值

## 調試建議

如果某個色光類型辨識不準確，可以：

1. 檢查該圖片的 HSV 和色溫數值
2. 調整 `classify_color()` 函數中的閾值
3. 例如：
   - 擴大色相角度範圍
   - 調整飽和度閾值
   - 調整色溫範圍

## 依賴

- OpenCV (`cv2`)
- NumPy (`np`)

安裝：
```bash
pip install opencv-python numpy
```
